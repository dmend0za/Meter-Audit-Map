<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meter Audit Map</title>
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            overflow: hidden;
            background-color: #f5f5f5;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }

        .controls {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .control-button {
            background: white;
            border: none;
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .control-button:hover {
            background: #f8f9fa;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            transform: translateY(-1px);
        }

        .control-button:active {
            transform: translateY(0);
        }

        .legend {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
            max-width: 200px;
            font-size: 12px;
        }

        .legend-list {
            list-style: none;
            margin: 0;
            padding: 0;
        }
        
        .legend-title {
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 10px;
            color: #333;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
            padding: 2px 0;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            margin-right: 8px;
            border: 2px solid;
            flex-shrink: 0;
        }

        .legend-item span {
            color: #333;
            font-size: 13px;
        }
        
        /* Special styling for Key Account legend item */
        .special-item {
            background-color: rgba(201, 210, 218, 0.2);
            padding: 4px 6px;
            border-radius: 4px;
            margin-bottom: 8px;
        }
        
        .legend-divider {
            height: 1px;
            background-color: #ddd;
            margin: 8px 0;
        }
        
        /* Completed notice styling */
        .completed-notice {
            text-align: center;
            padding: 10px;
            margin-top: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #e9ecef;
        }

        .stats {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1000;
            display: flex;
            gap: 15px;
        }

        .stat-item {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
            min-width: 80px;
        }

        .stat-number {
            display: block;
            font-size: 24px;
            font-weight: bold;
            color: #2563eb;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            color: #6b7280;
            font-weight: 500;
        }

        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px 30px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 2000;
            font-weight: 500;
            color: #374151;
        }

        /* Popup styles */
        .mapboxgl-popup-content {
            padding: 0;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }

        .popup-header {
            background: #2563eb;
            color: white;
            padding: 12px 15px;
            font-weight: bold;
            font-size: 14px;
            border-radius: 8px 8px 0 0;
        }

        .popup-info {
            padding: 8px 15px;
            border-bottom: 1px solid #f1f5f9;
            font-size: 13px;
        }

        .popup-info:last-child {
            border-bottom: none;
        }

        .popup-label {
            font-weight: 600;
            color: #374151;
        }

        .audit-button {
            background: #10b981;
            color: white;
            border: none;
            padding: 10px 15px;
            margin: 10px 15px 15px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            width: calc(100% - 30px);
            transition: background 0.2s ease;
        }

        .audit-button:hover {
            background: #059669;
        }

        /* Info message styles */
        .info-message {
            position: absolute;
            top: 100px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1500;
            font-weight: 500;
            max-width: 300px;
            animation: slideIn 0.3s ease;
        }

        .error-message {
            position: absolute;
            top: 100px;
            right: 20px;
            background: #ef4444;
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1500;
            font-weight: 500;
            max-width: 300px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .controls {
                top: 10px;
                right: 10px;
                gap: 8px;
            }

            .control-button {
                padding: 10px 12px;
                font-size: 12px;
            }

            .stats {
                top: 10px;
                left: 10px;
                gap: 10px;
            }

            .stat-item {
                padding: 10px;
                min-width: 60px;
            }

            .stat-number {
                font-size: 18px;
            }

            .stat-label {
                font-size: 11px;
            }

            .legend {
                bottom: 10px;
                right: 10px;
                padding: 12px;
                max-width: 160px;
                font-size: 11px;
            }

            .legend-title {
                font-size: 12px;
            }

            .legend-item span {
                font-size: 11px;
            }
        }
    </style>
</head>
<body>
    <nav class="controls" role="navigation" aria-label="Map controls">
        <button class="control-button" onclick="refreshData()" aria-label="Refresh map data">üîÑ Refresh Data</button>
        <button class="control-button" onclick="locateUser()" aria-label="Center map on your location">üìç My Location</button>
    </nav>

    <section class="stats" role="region" aria-label="Meter statistics">
        <div class="stat-item">
            <span class="stat-number" id="total-meters">0</span>
            <span class="stat-label">Total Meters</span>
        </div>
        <div class="stat-item">
            <span class="stat-number" id="pending-meters">0</span>
            <span class="stat-label">Pending Audits</span>
        </div>
    </section>

    <aside class="legend" role="complementary" aria-label="Map legend">
        </aside>

    <main id="map" role="main" aria-label="Interactive meter location map"></main>

    <div id="loading">Loading meter locations...</div>

    <script>
        // GLOBAL VARIABLES - These can stay outside if they don't depend on mapboxgl being loaded
        const GEOJSON_URL = 'https://dmend0za.github.io/Meter-Audit-Map/MeterInsp.geojson';
        const GOOGLE_SHEETS_CSV_URL = 'https://docs.google.com/spreadsheets/d/1wFGrinSXWHRYplgOLgD3tjx4-c0lv4JXncshfBhoBwc/export?format=csv&gid=0';
        const FILLOUT_FORM_BASE_URL = 'https://form.fillout.com/t/aKNfdeajwuus'; // Base URL for the Fillout form

        let map;
        let allMeters = []; // Stores all initial meter features from GeoJSON
        let completedMeterIds = new Set(); // Stores Meter IDs of completed audits
        let userLocation = null;
        let statusCheckInterval = null;

        // --- Map Initialization and Layer Setup ---

        /**
         * Initializes the Mapbox map and adds controls.
         * This function is called AFTER the DOM is loaded.
         */
        function initMap() {
            console.log('initMap: Map initialization started.');

            // *** Mapbox Access Token must be set AFTER Mapbox GL JS library has loaded ***
            // This is the crucial fix for "mapboxgl is not defined"
            mapboxgl.accessToken = 'pk.eyJ1IjoiZmllbGRzZW5zZSIsImEiOiJjbWMwb2ljY3YwNGFoMnJvaXN5c2xnMnR6In0.wc3C3TrsgsfyLf5ZJqHpnA';
            
            map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/satellite-v9',
                center: [-78.0, 35.8], // Centered on North Carolina
                zoom: 10
            });

            map.on('load', () => {
                console.log('initMap: Map loaded successfully.');
                setupMapLayers();
                loadMeterData(); // Initial load of meter data
                setupUserLocation();
                createLegend();
            });

            // Add standard navigation controls
            map.addControl(new mapboxgl.NavigationControl(), 'top-left');
        }

        /**
         * Sets up Mapbox layers for clusters, unclustered points, and labels.
         */
        function setupMapLayers() {
            console.log('setupMapLayers: Setting up Mapbox layers.');
            // Add source for meter data (initially empty, populated after data fetch)
            map.addSource('meters', {
                type: 'geojson',
                data: {
                    type: 'FeatureCollection',
                    features: []
                },
                cluster: true,
                clusterMaxZoom: 14,
                clusterRadius: 50
            });

            // Add cluster circles
            map.addLayer({
                id: 'clusters',
                type: 'circle',
                source: 'meters',
                filter: ['has', 'point_count'],
                paint: {
                    'circle-color': [
                        'step',
                        ['get', 'point_count'],
                        '#51bbd6', // Blue for small clusters
                        100,
                        '#f1f075', // Yellow for medium clusters
                        750,
                        '#f28cb1'  // Pink for large clusters
                    ],
                    'circle-radius': [
                        'step',
                        ['get', 'point_count'],
                        20, // Default radius
                        100,
                        30, // Larger for medium clusters
                        750,
                        40  // Even larger for large clusters
                    ]
                }
            });

            // Add cluster count labels
            map.addLayer({
                id: 'cluster-count',
                type: 'symbol',
                source: 'meters',
                filter: ['has', 'point_count'],
                layout: {
                    'text-field': '{point_count_abbreviated}',
                    'text-font': ['DIN Offc Pro Medium', 'Arial Unicode MS Bold'],
                    'text-size': 12
                }
            });

            // Add individual meter points with special Key Account handling
            map.addLayer({
                id: 'unclustered-point',
                type: 'circle',
                source: 'meters',
                filter: ['!', ['has', 'point_count']],
                paint: {
                    'circle-color': [
                        'case',
                        ['get', 'isKeyAccount'], '#c9d2da', // Gray-blue for Key Account meters
                        ['==', ['get', 'meterStyle'], '12S'], '#006400', // Dark Green
                        ['==', ['get', 'meterStyle'], '9S'], '#ef4444',    // Red
                        ['==', ['get', 'meterStyle'], '4S'], '#7f00ff',    // Purple
                        ['==', ['get', 'meterStyle'], '2S'], '#3b82f6',    // Blue
                        ['==', ['get', 'meterStyle'], '6S'], '#eab308',    // Yellow
                        ['==', ['get', 'meterStyle'], '1S'], '#f97316',    // Orange
                        ['==', ['get', 'meterStyle'], '35S'], '#a16207',   // Brown
                        ['==', ['get', 'meterStyle'], '16S'], '#000000',   // Black
                        '#ffffff' // White for other/unknown values
                    ],
                    'circle-radius': [
                        'case',
                        ['get', 'isKeyAccount'], 10, // Slightly larger for Key Accounts
                        8 // Regular size for others
                    ],
                    'circle-stroke-width': 2,
                    'circle-stroke-color': [
                        'case',
                        ['get', 'isKeyAccount'], '#000000', // Black outline for Key Account
                        ['==', ['get', 'meterStyle'], '16S'], '#ffffff', // White outline for black marker
                        ['in', ['get', 'meterStyle'], ['literal', ['12S', '9S', '4S', '2S', '6S', '1S', '35S']]], '#ffffff', // White outline for colored markers
                        '#333333' // Dark outline for white "Other" markers
                    ]
                }
            });

            // Add red X overlay for completed Key Account meters
            map.addLayer({
                id: 'completed-key-account-x',
                type: 'symbol',
                source: 'meters',
                // Only show X for unclustered, Key Account meters that are marked as completed
                filter: ['all', ['!', ['has', 'point_count']], ['get', 'isKeyAccount'], ['get', 'isCompleted']],
                layout: {
                    'text-field': '‚úï', // Unicode 'Multiplication X'
                    'text-font': ['DIN Offc Pro Medium', 'Arial Unicode MS Bold'],
                    'text-size': 20,
                    'text-anchor': 'center',
                    'text-allow-overlap': true // Allow X to overlap the circle
                },
                paint: {
                    'text-color': '#ff0000', // Bright red
                    'text-halo-color': '#ffffff',
